<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Mandelbrot Explorer v9.6.9 Kids UI</title>
  <link rel="icon" href="./favicon.ico" />
  <style>
    html,body{margin:0;height:100%;background:#0b0b0f;overflow:hidden}
    canvas{touch-action:none;display:block;width:100vw;height:100vh;touch-action:none}
    .hud{
      position:fixed;left:12px;top:12px;z-index:20;
      padding:10px 12px;border-radius:12px;
      background:rgba(0,0,0,.45);color:rgba(255,255,255,.88);
      font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      user-select:none;pointer-events:none;white-space:pre-wrap;
      backdrop-filter: blur(10px);
      max-width:min(680px,calc(100vw - 24px));
    }
    .panel{
      position:fixed;right:12px;top:12px;z-index:30;
      width:min(430px,calc(100vw - 24px));
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.45);color:rgba(255,255,255,.9);
      font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 30px rgba(0,0,0,.35);
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0}
    .row label{opacity:.9}
    .row input[type="range"]{width:220px}
    .row input[type="number"], .row select{
      width:150px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
      border-radius:10px;color:#fff;padding:6px 8px;outline:none;
      font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    }
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{
      border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);
      color:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;
      font:12px system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    button:hover{background:rgba(255,255,255,.14)}
    .hint{opacity:.8;margin-top:8px}
    #errBox{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;
      background:rgba(140,0,0,.88);color:#fff;border-radius:14px;
      padding:10px 12px;display:none;white-space:pre-wrap;
      font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      max-height:40vh;overflow:auto;
    }
  
      position:fixed; inset:0; display:none; z-index:9999;
      background:rgba(0,0,0,0.70);
      backdrop-filter: blur(3px);
    }
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(720px, calc(100vw - 24px));
      background:#111; color:#eee; border:1px solid #333;
      border-radius:14px; padding:18px 18px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
    }
      background:#151515; border:1px solid #2a2a2a; border-radius:12px;
      padding:10px 12px; line-height:1.35;
    }
      border:1px solid #3a3a3a; background:#1b1b1b; color:#eee;
      border-radius:10px; padding:8px 12px; cursor:pointer;
    }
    @media (max-width: 640px){
    }

    #deepBadge{
      position:fixed; left:10px; top:10px; z-index:9998;
      font: 700 12px/1.0 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing: .08em;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color:#cfcfcf;
      user-select:none;
      pointer-events:none;
      text-transform: uppercase;
    }
    #deepBadge.on{ background: rgba(30,140,60,0.32); color:#eaffef; border-color: rgba(60,255,120,0.35); }
    #deepBadge.standby{ background: rgba(0,0,0,0.35); color:#d9d9d9; border-color: rgba(255,255,255,0.18); }
    #deepBadge.off{ background: rgba(140,30,30,0.32); color:#ffecec; border-color: rgba(255,120,120,0.35); }
    #toast{
      position:fixed; left:50%; top:20px; transform:translateX(-50%);
      z-index:9999;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.55);
      color:#fff;
      font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing: .02em;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      white-space: nowrap;
    }
    #toast.show{ opacity: 1; }

    .chk{display:flex;align-items:center;gap:8px;font-size:12px;color:#bbb;margin-left:10px;user-select:none}
    .chk input{transform:translateY(1px)}

    .kidsTop{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
    .kidsTitle{font:700 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;letter-spacing:.02em;color:#fff}
    .kidsSub{font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;color:#cfcfcf}
    .bigBtns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .bigBtns button{padding:12px 10px;border-radius:14px;font-size:13px;font-weight:700}
    .bigBtns button.primary{border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08)}
    .bigBtns button.alt{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25)}
    details.advanced{margin-top:10px;border-top:1px solid rgba(255,255,255,.10);padding-top:8px}
    details.advanced summary{cursor:pointer;user-select:none;color:#ddd;font-weight:700;list-style:none}
    details.advanced summary::-webkit-details-marker{display:none}
    details.advanced summary:before{content:"▶";display:inline-block;margin-right:6px;opacity:.8;transform:translateY(-1px)}
    details.advanced[open] summary:before{content:"▼"}
    .hint{opacity:.85}

    canvas{touch-action:none}
    html,body{overscroll-behavior:none}

    .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer}
    .pill:active{transform:translateY(1px)}
    .tiny{font-size:12px;opacity:.75}

    /* --- Mobile compact UI --- */
    .kidsHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .kidsHeaderText{min-width:0}
    .uiToggleBtn{
      flex:0 0 auto;
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#fff;font-size:18px;font-weight:900;
      cursor:pointer;
    }
    .uiToggleBtn:active{transform:translateY(1px)}
    .zoomBtns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .zoomBtns button{padding:12px 10px;border-radius:14px;font-size:16px;font-weight:900}
    .zoomBtns button.alt{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25)}
    .panel.compact .kidsSub{display:none}
    .panel.compact details.advanced{display:none}
    .panel.compact .row{display:none}
    .panel.compact .zoomBtns{display:grid}
    .panel.compact .bigBtns button{padding:10px 10px;font-size:12px}
    .panel.compact{padding:10px 10px;border-radius:16px}
    @media (max-width: 520px){
      .panel{right:8px;left:8px;top:8px;width:auto;padding:10px 10px;border-radius:16px}
      .kidsTitle{font-size:13px}
      .bigBtns{gap:6px}
      .bigBtns button{padding:10px 8px;font-size:12px;border-radius:14px}
      .zoomBtns{gap:6px}
      .zoomBtns button{padding:10px 8px;font-size:15px;border-radius:14px}
    }

  
/* MOBILE_COMPACT_V960 */
#mobileFab{
  position:fixed;
  left:12px;
  bottom: calc(12px + env(safe-area-inset-bottom));
  display:none;
  gap:10px;
  z-index:2147483600;
}
#mobileFab .fab{
  width:48px; height:48px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  color:#fff;
  font:800 18px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
#mobileFab .fab:active{ transform: translateY(1px); }

@media (max-width: 520px){
  #mobileFab{ display:flex; }

    right:10px; bottom: calc(12px + env(safe-area-inset-bottom));
    font-size:11px; padding:6px 9px;
    border-radius:999px;
  }

  #uiPanel{
    position:fixed;
    left:10px; right:10px;
    top:10px;
    z-index:2147483500;
    max-height: 30vh;
    overflow:auto;
    padding:10px;
    border-radius:18px;
  }
  #uiPanel h1{ font-size:18px; margin:0 0 6px 0; }
  #uiPanel button{ min-height:44px; font-size:15px; }
  #uiPanel .grid2{ gap:10px; }
  #uiPanel .tiny, #uiPanel .helptext{ font-size:12px; }

  #uiPanel.collapsed_removed{
    max-height: 64px;
    overflow:hidden;
    padding-bottom:8px;
  }
  #uiPanel.collapsed_removed .grid2,
  #uiPanel.collapsed_removed .row,
  #uiPanel.collapsed_removed details{
    display:none !important;
  }
  #uiPanel .collapseBar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top:6px;
  }
    /* Robust collapse: hide everything except title + bar */
  #uiPanel.collapsed_removed > *{ display:none !important; }
  #uiPanel.collapsed_removed h1{ display:block !important; }
  #uiPanel.collapsed_removed .collapseBar{ display:flex !important; }

  #uiPanel .collapseBtn{
    padding:8px 12px;
    min-height:40px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:#fff;
    font-weight:800;
  }
}

/* MOBILE_PANEL_TOGGLE_V961 */
#fabPanel{
  position:fixed;
  right:12px;
  bottom: calc(12px + env(safe-area-inset-bottom));
  width:48px; height:48px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  color:#fff;
  font:900 18px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  z-index:2147483647;
  display:none;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
#fabPanel:active{ transform: translateY(1px); }

#uiPanel.hidden{ display:none !important; }
#uiPanel{ position:fixed; }

@media (max-width: 520px){
  #fabPanel{ display:block; }
  /* on phone: panel should not take entire screen; keep scroll */
  #uiPanel{
    left:10px; right:10px; top:10px;
    max-height: 60vh;
    overflow:auto;
  }
  #panelClose{
    position:absolute;
    right:10px; top:10px;
    width:40px; height:40px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.35);
    color:#fff;
    font-size:22px;
    line-height:40px;
    font-weight:900;
  }
}

/* PANEL_SHOWHIDE_V962 */
#uiPanel.hidden{ display:none !important; }
#fabPanel{
  position:fixed;
  right:12px;
  bottom: calc(12px + env(safe-area-inset-bottom));
  width:48px; height:48px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  color:#fff;
  font:900 18px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  z-index:2147483601;
  display:block;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
#fabPanel:active{ transform: translateY(1px); }

@media (max-width: 520px){
  /* phone: start hidden, show via ? */
  #uiPanel{ max-height: 60vh; overflow:auto; }
}
</style>
</head>
<body>

  <canvas id="c"></canvas>
  <div id="hud" class="hud">Loading…</div>

  <div class="panel" id="uiPanel">

    <div class="kidsTop">
      <div class="kidsHeader">
        <div class="kidsHeaderText">
          <div class="kidsTitle">マンデルブロ探検</div>
          <div class="kidsSub">ズーム：＋/−（スマホ）／ホイール（PC）
スマホ：＋/−でズーム／1本指ドラッグで移動／ダブルタップで中心（CAD式） / 左クリック/ホイール押し込みでドラッグ / きれいに描く→画像保存</div>
        </div>
        <button id="panelClose" class="uiToggleBtn" title="閉じる" aria-label="閉じる">×</button>
      </div>
      <div class="bigBtns">
        <button id="hqBtn" class="primary" title="段階的に高精細化（重い）">きれいに描く</button>
        <button id="saveBtn" class="alt" title="PNGとして保存">画像を保存</button>
        <button id="resetBtn" class="alt" title="最初にもどる">はじめにもどる</button>
        
      </div>
      <div class="row">
        <label>ズームの速さ <span id="zoomSpeedVal" style="color:#bbb;font-size:12px;margin-left:6px;">0.65×</span></label>
        <input id="zoomSpeed" type="range" min="0.05" max="2.50" step="0.01" value="0.65" />
      </div>
</div>
        <details class="advanced"><summary>設定</summary>
<div class="row">
      <label>モード</label>
      <select id="mode">
        <option value="ultradeep" selected>UltraDeep (BigInt)</option>
        <option value="standard">Standard (float64)</option>
      </select>
    </div>
    <div class="row">
      <label>内部解像度</label>
      <input id="res" type="range" min="0.30" max="1.00" step="0.05" value="0.70" />
    </div>
    <div class="row">
      <label>step（粗さ）</label>
      <select id="step">
        <option value="1">1 (最高画質)</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="12">12</option>
      </select>
    </div>
    <div class="row">
      <label>反復上限</label>
      <input id="iterCap" type="number" min="150" max="30000" step="50" value="1400" />
    </div>
    <div class="row">
      <label>bits（精度）</label>
      <input id="bits" type="number" min="96" max="8192" step="64" value="512" />
    </div>
    <div class="row">
      <label>Auto bits</label>
      <input id="autoBits" type="checkbox" checked />
    </div>
    <div class="row">
      <label>操作中プレビュー</label>
      <input id="preview" type="checkbox" checked />
    </div>
    <div class="row">
      <label>停止後に高精細</label>
      <input id="autoSettle" type="checkbox" />
    </div>
    </details>

<div class="hint">
  【スマホ】
① ＋／−：ズーム
② 1本指ドラッグ：移動
③ ダブルタップ：そこを中心にする

【PC】
① ホイール：ズーム（カーソルのところ）<br/>
  ② 左クリック または ホイール押し込み：移動（ドラッグ）<br/>
  ③ ダブルクリック：そこを中心にする<br/>④ きれいに描く → 画像を保存
</div>
  </div>

  
  <div><span class="k">ドラッグ</span>移動（パン）</div></div>
        <div class="card"><div><span class="k">クリック</span>中心合わせ</div><div><span class="k">ダブルクリック</span>中心合わせ＋ズームイン</div></div>
        <div class="card"><div><span class="k">きれいに描く</span>止め絵を高精細で仕上げ</div><div><span class="k">Save PNG / S</span>画像として保存</div></div>
        <div class="card"><div><span class="k">超深度</span>超深度允许（ONなら深い領域で自動的にDeepNavに移行。HUDのactiveがONになります）</div><div><span class="k">Reset / R</span>初期位置へ</div></div>
      </div>

    <div class="row">
      <label>スマホモード</label>
      <div class="ctrl">
        <button id="mobileModeBtn" class="pill" title="スマホ向け軽量設定">OFF</button>
        <span class="tiny">（軽く動く）</span>
      </div>
    </div>
    <div class="row">
      <label>ズーム</label>
      <div class="ctrl">
        <button id="zoomOutBtn" class="pill" title="ズームアウト">−</button>
        <button id="zoomInBtn" class="pill" title="ズームイン">＋</button>
        <span class="tiny">（指はドラッグ移動）</span>
      </div>
    </div>
</div>
  </div>

<div id="errBox"></div>

  <!-- Bootloader: app.js が落ちてもエラーを画面に出す -->
  <script>
    (function(){
      const errBox = document.getElementById('errBox');
      function showErr(t){
        errBox.style.display='block';
        errBox.textContent = t;
      }
      window.addEventListener('error', (e)=> showErr('[window.error]\n'+e.message+'\n'+e.filename+':'+e.lineno+':'+e.colno));
      window.addEventListener('unhandledrejection', (e)=> showErr('[unhandledrejection]\n'+((e.reason&& (e.reason.stack||e.reason.message))||e.reason)));

      const build = '20251214_v7_' + Date.now().toString(36);
      const s = document.createElement('script');
      s.src = './app.js?v=' + build; // cache bust
      s.defer = true;
      s.onerror = ()=>showErr('[load error]\napp.js failed to load');
      document.head.appendChild(s);
    })();
  </script>

<div id="mobileFab" aria-hidden="false">
  <button id="fabZoomOut" class="fab" title="ズームアウト">−</button>
  <button id="fabZoomIn" class="fab" title="ズームイン">＋</button>
</div>

<button id="fabPanel" title="操作パネル" aria-label="操作パネル">？</button>

<script>
/* PANEL_TOGGLE_INLINE_V968: works even if app.js is cached or throws */
(function(){
  function setPanelVisible(on){
    var p = document.getElementById('uiPanel');
    if(!p) return;
    p.classList.toggle('hidden', !on);
  }
  function togglePanel(){
    var p = document.getElementById('uiPanel');
    if(!p) return;
    setPanelVisible(p.classList.contains('hidden'));
  }
  window.__togglePanel = togglePanel;

  function bind(){
    var fab = document.getElementById('fabPanel');
    var closeBtn = document.getElementById('panelClose');
    if(fab){
      fab.onclick = function(ev){ ev && ev.preventDefault && ev.preventDefault(); togglePanel(); };
      fab.addEventListener('touchend', function(ev){ ev.preventDefault(); togglePanel(); }, {passive:false});
      fab.style.pointerEvents = 'auto';
    }
    if(closeBtn){
      closeBtn.onclick = function(ev){ ev && ev.preventDefault && ev.preventDefault(); setPanelVisible(false); };
      closeBtn.addEventListener('touchend', function(ev){ ev.preventDefault(); setPanelVisible(false); }, {passive:false});
    }
    // mobile: start hidden
    try{
      if (window.matchMedia && matchMedia('(max-width: 520px)').matches) setPanelVisible(false);
    }catch(e){}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind, {once:true});
  }else{
    bind();
  }
  window.addEventListener('pageshow', function(){ try{ bind(); }catch(e){} }, {passive:true});
})();
</script>

</body>
</html>