<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Mandelbrot Explorer v9.6.0 Kids UI</title>
  <link rel="icon" href="./favicon.ico" />
  <style>
    html,body{margin:0;height:100%;background:#0b0b0f;overflow:hidden}
    canvas{touch-action:none;display:block;width:100vw;height:100vh;touch-action:none}
    .hud{
      position:fixed;left:12px;top:12px;z-index:20;
      padding:10px 12px;border-radius:12px;
      background:rgba(0,0,0,.45);color:rgba(255,255,255,.88);
      font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      user-select:none;pointer-events:none;white-space:pre-wrap;
      backdrop-filter: blur(10px);
      max-width:min(680px,calc(100vw - 24px));
    }
    .panel{
      position:fixed;right:12px;top:12px;z-index:30;
      width:min(430px,calc(100vw - 24px));
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.45);color:rgba(255,255,255,.9);
      font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 30px rgba(0,0,0,.35);
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0}
    .row label{opacity:.9}
    .row input[type="range"]{width:220px}
    .row input[type="number"], .row select{
      width:150px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
      border-radius:10px;color:#fff;padding:6px 8px;outline:none;
      font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    }
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{
      border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);
      color:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;
      font:12px system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    button:hover{background:rgba(255,255,255,.14)}
    .hint{opacity:.8;margin-top:8px}
    #errBox{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;
      background:rgba(140,0,0,.88);color:#fff;border-radius:14px;
      padding:10px 12px;display:none;white-space:pre-wrap;
      font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      max-height:40vh;overflow:auto;
    }
  
    /* Help overlay */
    #helpOverlay{
      position:fixed; inset:0; display:none; z-index:9999;
      background:rgba(0,0,0,0.70);
      backdrop-filter: blur(3px);
    }
    #helpOverlay .panel{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(720px, calc(100vw - 24px));
      background:#111; color:#eee; border:1px solid #333;
      border-radius:14px; padding:18px 18px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
    }
    #helpOverlay h2{ margin:0 0 10px; font-size:18px; font-weight:700; }
    #helpOverlay .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    #helpOverlay .card{
      background:#151515; border:1px solid #2a2a2a; border-radius:12px;
      padding:10px 12px; line-height:1.35;
    }
    #helpOverlay .k{ display:inline-block; min-width: 9.5em; color:#bbb; }
    #helpOverlay .note{ color:#bbb; font-size:12px; margin-top:10px; }
    #helpOverlay .btnRow{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    #helpOverlay button{
      border:1px solid #3a3a3a; background:#1b1b1b; color:#eee;
      border-radius:10px; padding:8px 12px; cursor:pointer;
    }
    #helpOverlay button:hover{ background:#242424; }
    @media (max-width: 640px){
      #helpOverlay .grid{ grid-template-columns: 1fr; }
    }

    #deepBadge{
      position:fixed; left:10px; top:10px; z-index:9998;
      font: 700 12px/1.0 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing: .08em;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color:#cfcfcf;
      user-select:none;
      pointer-events:none;
      text-transform: uppercase;
    }
    #deepBadge.on{ background: rgba(30,140,60,0.32); color:#eaffef; border-color: rgba(60,255,120,0.35); }
    #deepBadge.standby{ background: rgba(0,0,0,0.35); color:#d9d9d9; border-color: rgba(255,255,255,0.18); }
    #deepBadge.off{ background: rgba(140,30,30,0.32); color:#ffecec; border-color: rgba(255,120,120,0.35); }
    #toast{
      position:fixed; left:50%; top:20px; transform:translateX(-50%);
      z-index:9999;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.55);
      color:#fff;
      font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing: .02em;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      white-space: nowrap;
    }
    #toast.show{ opacity: 1; }

    .chk{display:flex;align-items:center;gap:8px;font-size:12px;color:#bbb;margin-left:10px;user-select:none}
    .chk input{transform:translateY(1px)}

    .kidsTop{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
    .kidsTitle{font:700 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;letter-spacing:.02em;color:#fff}
    .kidsSub{font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;color:#cfcfcf}
    .bigBtns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .bigBtns button{padding:12px 10px;border-radius:14px;font-size:13px;font-weight:700}
    .bigBtns button.primary{border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08)}
    .bigBtns button.alt{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25)}
    details.advanced{margin-top:10px;border-top:1px solid rgba(255,255,255,.10);padding-top:8px}
    details.advanced summary{cursor:pointer;user-select:none;color:#ddd;font-weight:700;list-style:none}
    details.advanced summary::-webkit-details-marker{display:none}
    details.advanced summary:before{content:"▶";display:inline-block;margin-right:6px;opacity:.8;transform:translateY(-1px)}
    details.advanced[open] summary:before{content:"▼"}
    .hint{opacity:.85}

    canvas{touch-action:none}
    html,body{overscroll-behavior:none}

    #verFixed{
      position:fixed; right:10px; bottom:10px; z-index:2147483647;
      padding:8px 10px; border-radius:12px;
      background: rgba(0,0,0,0.65);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      font:700 12px/1.1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing:.02em;
      pointer-events:none;
      user-select:none;
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
    }

    .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer}
    .pill:active{transform:translateY(1px)}
    .tiny{font-size:12px;opacity:.75}

    /* --- Mobile compact UI --- */
    .kidsHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .kidsHeaderText{min-width:0}
    .uiToggleBtn{
      flex:0 0 auto;
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#fff;font-size:18px;font-weight:900;
      cursor:pointer;
    }
    .uiToggleBtn:active{transform:translateY(1px)}
    .zoomBtns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .zoomBtns button{padding:12px 10px;border-radius:14px;font-size:16px;font-weight:900}
    .zoomBtns button.alt{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25)}
    .panel.compact .kidsSub{display:none}
    .panel.compact details.advanced{display:none}
    .panel.compact .row{display:none}
    .panel.compact .zoomBtns{display:grid}
    .panel.compact .bigBtns button{padding:10px 10px;font-size:12px}
    .panel.compact{padding:10px 10px;border-radius:16px}
    @media (max-width: 520px){
      .panel{right:8px;left:8px;top:8px;width:auto;padding:10px 10px;border-radius:16px}
      .kidsTitle{font-size:13px}
      .bigBtns{gap:6px}
      .bigBtns button{padding:10px 8px;font-size:12px;border-radius:14px}
      .zoomBtns{gap:6px}
      .zoomBtns button{padding:10px 8px;font-size:15px;border-radius:14px}
    }

  
/* MOBILE_COMPACT_V960 */
#mobileFab{
  position:fixed;
  left:12px;
  bottom: calc(12px + env(safe-area-inset-bottom));
  display:none;
  gap:10px;
  z-index:2147483600;
}
#mobileFab .fab{
  width:48px; height:48px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  color:#fff;
  font:800 18px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
#mobileFab .fab:active{ transform: translateY(1px); }

@media (max-width: 520px){
  #mobileFab{ display:flex; }

  #verFixed{
    right:10px; bottom: calc(12px + env(safe-area-inset-bottom));
    font-size:11px; padding:6px 9px;
    border-radius:999px;
  }

  #kidsTop{
    position:fixed;
    left:10px; right:10px;
    top:10px;
    z-index:2147483500;
    max-height: 30vh;
    overflow:auto;
    padding:10px;
    border-radius:18px;
  }
  #kidsTop h1{ font-size:18px; margin:0 0 6px 0; }
  #kidsTop button{ min-height:44px; font-size:15px; }
  #kidsTop .grid2{ gap:10px; }
  #kidsTop .tiny, #kidsTop .helptext{ font-size:12px; }

  #kidsTop.collapsed{
    max-height: 64px;
    overflow:hidden;
    padding-bottom:8px;
  }
  #kidsTop.collapsed .grid2,
  #kidsTop.collapsed .row,
  #kidsTop.collapsed details{
    display:none !important;
  }
  #kidsTop .collapseBar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top:6px;
  }
    /* Robust collapse: hide everything except title + bar */
  #kidsTop.collapsed > *{ display:none !important; }
  #kidsTop.collapsed h1{ display:block !important; }
  #kidsTop.collapsed .collapseBar{ display:flex !important; }

  #kidsTop .collapseBtn{
    padding:8px 12px;
    min-height:40px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:#fff;
    font-weight:800;
  }
}
</style>
</head>
<body>
<div id="verFixed"></div>
  <canvas id="c"></canvas>
  <div id="hud" class="hud">Loading…</div>

  <div class="panel">

    <div class="kidsTop">
      <div class="kidsHeader">
        <div class="kidsHeaderText">
          <div class="kidsTitle">マンデルブロ探検</div>
          <div class="kidsSub">ズーム：＋/−（スマホ）／ホイール（PC）（CAD式） / 左クリック/ホイール押し込みでドラッグ / きれいに描く→画像保存</div>
        </div>
        <button id="uiToggleBtn" class="uiToggleBtn" title="メニューをたたむ/開く">≡</button>
      </div>
      <div class="bigBtns">
        <button id="hqBtn" class="primary" title="段階的に高精細化（重い）">きれいに描く</button>
        <button id="saveBtn" class="alt" title="PNGとして保存">画像を保存</button>
        <button id="resetBtn" class="alt" title="最初にもどる">はじめにもどる</button>
        <button id="helpBtn" class="alt" title="つかいかた">つかいかた</button>
      </div>
      <div class="row">
        <label>ズームの速さ <span id="zoomSpeedVal" style="color:#bbb;font-size:12px;margin-left:6px;">0.65×</span></label>
        <input id="zoomSpeed" type="range" min="0.05" max="2.50" step="0.01" value="0.65" />
      </div>
</div>
        <details class="advanced"><summary>くわしく</summary>
<div class="row">
      <label>モード</label>
      <select id="mode">
        <option value="ultradeep" selected>UltraDeep (BigInt)</option>
        <option value="standard">Standard (float64)</option>
      </select>
    </div>
    <div class="row">
      <label>内部解像度</label>
      <input id="res" type="range" min="0.30" max="1.00" step="0.05" value="0.70" />
    </div>
    <div class="row">
      <label>step（粗さ）</label>
      <select id="step">
        <option value="1">1 (最高画質)</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="12">12</option>
      </select>
    </div>
    <div class="row">
      <label>反復上限</label>
      <input id="iterCap" type="number" min="150" max="30000" step="50" value="1400" />
    </div>
    <div class="row">
      <label>bits（精度）</label>
      <input id="bits" type="number" min="96" max="8192" step="64" value="512" />
    </div>
    <div class="row">
      <label>Auto bits</label>
      <input id="autoBits" type="checkbox" checked />
    </div>
    <div class="row">
      <label>操作中プレビュー</label>
      <input id="preview" type="checkbox" checked />
    </div>
    <div class="row">
      <label>停止後に高精細</label>
      <input id="autoSettle" type="checkbox" />
    </div>
    </details>

<div class="hint">
  ① ホイール：ズーム（カーソルのところ）<br/>
  ② 左クリック または ホイール押し込み：移動（ドラッグ）<br/>
  ③ ダブルクリック：そこを中心にする<br/>④ きれいに描く → 画像を保存
</div>
  </div>

  
  <div id="helpOverlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="使い方">
      <h2>つかいかた（かんたん）</h2>
      <div class="grid">
        <div class="card"><div><span class="k">ホイール</span>ズーム（カーソル中心）</div><div><span class="k">ドラッグ</span>移動（パン）</div></div>
        <div class="card"><div><span class="k">クリック</span>中心合わせ</div><div><span class="k">ダブルクリック</span>中心合わせ＋ズームイン</div></div>
        <div class="card"><div><span class="k">きれいに描く</span>止め絵を高精細で仕上げ</div><div><span class="k">Save PNG / S</span>画像として保存</div></div>
        <div class="card"><div><span class="k">超深度</span>超深度允许（ONなら深い領域で自動的にDeepNavに移行。HUDのactiveがONになります）</div><div><span class="k">Reset / R</span>初期位置へ</div></div>
      </div>

    <div class="row">
      <label>スマホモード</label>
      <div class="ctrl">
        <button id="mobileModeBtn" class="pill" title="スマホ向け軽量設定">OFF</button>
        <span class="tiny">（軽く動く）</span>
      </div>
    </div>
    <div class="row">
      <label>ズーム</label>
      <div class="ctrl">
        <button id="zoomOutBtn" class="pill" title="ズームアウト">−</button>
        <button id="zoomInBtn" class="pill" title="ズームイン">＋</button>
        <span class="tiny">（指はドラッグ移動）</span>
      </div>
    </div>

      <div class="note">
        Tip: まずは適当にズームして、良い場所でHQ Render → Save PNG がおすすめです。<br/>
        ※更新したのに表示が変わらない場合は Pages側の reset.html（キャッシュ掃除）を一度開いてください。
      </div>
      <div class="btnRow">
        <button id="helpDontShow">次回は表示しない</button>
        <button id="helpClose">閉じる</button>
      </div>
    </div>
  </div>

<div id="errBox"></div>

  <!-- Bootloader: app.js が落ちてもエラーを画面に出す -->
  <script>
    (function(){
      const errBox = document.getElementById('errBox');
      function showErr(t){
        errBox.style.display='block';
        errBox.textContent = t;
      }
      window.addEventListener('error', (e)=> showErr('[window.error]\n'+e.message+'\n'+e.filename+':'+e.lineno+':'+e.colno));
      window.addEventListener('unhandledrejection', (e)=> showErr('[unhandledrejection]\n'+((e.reason&& (e.reason.stack||e.reason.message))||e.reason)));

      const build = '20251214_v7_' + Date.now().toString(36);
      const s = document.createElement('script');
      s.src = './app.js?v=' + build; // cache bust
      s.defer = true;
      s.onerror = ()=>showErr('[load error]\napp.js failed to load');
      document.head.appendChild(s);
    })();
  </script>

<script>
(() => {
  const el = document.getElementById('verFixed');
  if (!el) return;
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v') || '9.6.0';
  el.textContent = `v${v}  build:2025-12-16T10:54:08Z`;
})();
</script>

<div id="mobileFab" aria-hidden="false">
  <button id="fabMenu" class="fab" title="メニュー">≡</button>
  <button id="fabZoomOut" class="fab" title="ズームアウト">−</button>
  <button id="fabZoomIn" class="fab" title="ズームイン">＋</button>
</div>
</body>
</html>
